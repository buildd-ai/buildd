name: CI Auto-Fix

on:
  workflow_run:
    workflows: ["Build & Test"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  auto-fix:
    runs-on: ubuntu-latest
    if: >
      github.event.workflow_run.conclusion == 'failure' &&
      github.event.workflow_run.head_branch == 'dev' &&
      !contains(github.event.workflow_run.head_commit.message, 'autofix:')
    steps:
      - uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0

      - uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Get failed job logs
        id: logs
        run: |
          RUN_ID=${{ github.event.workflow_run.id }}
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          LOGS=$(gh run view $RUN_ID --log-failed 2>&1 | tail -100)
          {
            echo 'CI_FAILURE_LOGS<<EOFLOG'
            echo "$LOGS"
            echo 'EOFLOG'
          } >> $GITHUB_ENV
        env:
          GH_TOKEN: ${{ github.token }}

      - uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            The CI build failed on the dev branch. Here are the last 100 lines of the failed job logs:

            ```
            ${{ env.CI_FAILURE_LOGS }}
            ```

            Dependencies are already installed. Fix the issue directly:
            1. Read the error messages above to identify the root cause
            2. Fix the source files (the codebase is already checked out)
            3. If schema changed, run: cd packages/core && bun db:generate
            4. Verify your fix: cd apps/web && bunx tsc --noEmit
            5. Commit and push with prefix "autofix:" so this workflow doesn't loop

            IMPORTANT: Do NOT spend turns downloading or re-reading CI logs - they are provided above.
            Use `git push origin dev` to push your fix.
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--max-turns 30 --allowedTools "Bash(*),Edit,Read,Write,Glob,Grep"'
