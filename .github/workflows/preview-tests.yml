name: Preview Integration Tests

on:
  deployment_status

jobs:
  test:
    if: |
      github.event.deployment_status.state == 'success' &&
      github.event.deployment_status.environment == 'Preview'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install

      - name: Run preview integration tests
        run: |
          bun test apps/web/tests/integration/concurrency.test.ts \
               apps/web/tests/integration/worker-state-machine.test.ts \
               apps/web/tests/integration/schedule-triggers.test.ts
        env:
          BUILDD_TEST_SERVER: ${{ github.event.deployment_status.target_url }}
          BUILDD_API_KEY: ${{ secrets.BUILDD_API_KEY }}
          BUILDD_ADMIN_API_KEY: ${{ secrets.BUILDD_ADMIN_API_KEY }}
