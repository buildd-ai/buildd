name: Build & Test

on:
  push:
    branches: [dev]
  pull_request:
    branches: [main, dev]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install

      - name: Check migrations are up to date
        run: |
          cd packages/core
          bun db:generate
          if [ -n "$(git status --porcelain drizzle/)" ]; then
            echo "::error::Schema changes detected but migrations not committed!"
            echo "Run 'cd packages/core && bun db:generate' and commit the generated files."
            git status drizzle/
            git diff drizzle/
            exit 1
          fi
          echo "Migrations are up to date"

      - name: Type check
        run: cd apps/web && bunx tsc --noEmit

      - name: Detect affected tests
        id: affected
        run: |
          AFFECTED=$(bash scripts/affected-tests.sh)
          echo "tests=$AFFECTED" >> "$GITHUB_OUTPUT"

      - name: Run tests
        if: steps.affected.outputs.tests != 'SKIP'
        run: |
          TESTS="${{ steps.affected.outputs.tests }}"
          if [ "$TESTS" = "ALL" ]; then
            echo "Running all tests..."
            bun test apps/web/src apps/runner/__tests__/unit
          else
            echo "Running affected tests: $TESTS"
            bun test $TESTS
          fi

      - name: Build
        run: cd apps/web && bun run build:only
        env:
          # Dummy values for build (not connecting to real DB)
          DATABASE_URL: "postgresql://dummy:dummy@localhost:5432/dummy"
          AUTH_SECRET: "dummy-secret-for-build"

  integration:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && (github.base_ref == 'main' || github.base_ref == 'dev')

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"

      - name: Install dependencies
        run: bun install

      - name: Connect to Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Start preview runner
        run: |
          tailscale ssh ubuntu@100.82.109.19 << 'SCRIPT'
            docker exec coder-ai-run-my-claude-workspace bash -c '
              export PATH="$HOME/.local/bin:$HOME/.bun/bin:$PATH"
              # Kill any existing test instance
              screen -X -S buildd-test quit 2>/dev/null || true
              screen -dmS buildd-test bash -c "
                export PATH=\"$HOME/.local/bin:$HOME/.bun/bin:\$PATH\"
                export PORT=8767
                export BUILDD_API_KEY=$BUILDD_API_KEY
                export BUILDD_SERVER='"${BUILDD_TEST_SERVER}"'
                buildd >> /tmp/buildd-test.log 2>&1
              "
            '
          SCRIPT
          sleep 5

      - name: Integration tests
        run: |
          bun test apps/web/tests/integration/concurrency.test.ts \
               apps/web/tests/integration/worker-state-machine.test.ts \
               apps/runner/__tests__/integration-config.test.ts
        env:
          BUILDD_TEST_SERVER: ${{ secrets.BUILDD_TEST_SERVER }}
          BUILDD_API_KEY: ${{ secrets.BUILDD_API_KEY }}
          LOCAL_UI_URL: http://100.82.109.19:8767

      - name: E2E dogfood tests
        run: bun test tests/e2e/server-worker-flow.test.ts
        timeout-minutes: 10
        env:
          BUILDD_TEST_SERVER: ${{ secrets.BUILDD_TEST_SERVER }}
          BUILDD_API_KEY: ${{ secrets.BUILDD_API_KEY }}
          LOCAL_UI_URL: http://100.82.109.19:8767
          SKIP_LOCAL_UI_START: "1"

      - name: Cleanup preview runner
        if: always()
        run: tailscale ssh ubuntu@100.82.109.19 'docker exec coder-ai-run-my-claude-workspace screen -X -S buildd-test quit' || true
